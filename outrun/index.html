<html>

<body style="background-color:black">
    <canvas id="canvas" width="320" height="240"></canvas>

    <script type="text/javascript">

        var ferrari = new Image();
        ferrari.src = "assets/ferrari.png";

        var background = new Image();
        setInterval(function () {
            draw(background);
        }, 20);

        var dx = [];
        var offset_x = 0;
        for (var x = 0; x < canvas.width; x++) {
            dx.push(offset_x);
            offset_x += 4;
        }

        var dy = [];
        var offset_y = 0;
        for (var y = 0; y < canvas.height; y++) {
            dy.push(offset_y);
            offset_y += offset_x;
        }

        // perspective
        var y1 = 180;
        var y2 = 240
        var lx = [];
        var rx = [];
        for (var y = 0; y < y1; y++) {
            lx.push(0);
            rx.push(0);
        }
        var offset_xy = dx;
        var x1 = 100;
        var x2 = canvas.width - x1;
        for (var y = y1; y < y2; y++) {
            lx.push(parseInt(x1));
            rx.push(parseInt(x2));
            x1 -= 0.6;
            x2 = canvas.width - x1;
        }

        var road_colors = [{
            "grass": [0, 255, 0, 255],
            "border": [255, 0, 0, 255],
            "road": [128, 128, 128, 255],
        },
        {
            "grass": [0, 128, 0, 255],
            "border": [255, 255, 255, 255],
            "road": [192, 192, 192, 255],
        }];
        var stripe_offset_width = 8;
        var stripe_offset = stripe_offset_width-1;
        var stripe_colors_index = 0;

        function draw(background) {
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = "cyan";
            ctx.fillRect(0, 0, canvas.width, y1);
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var data = imageData.data;

            var y_stripe_offset = stripe_offset;
            var y_stripe_colors_index = stripe_colors_index;

            var offset = dy[y1];
            for (var y = y1; y < y2; y++) {

                var llx = lx[y];
                var llx2 = llx + 4;
                var rrx = rx[y];
                var rrx2 = rrx - 4;

                var x = 0;

                var colors = road_colors[y_stripe_colors_index];

                while (true) {
                    if (x == llx) break;
                    pixel(data, offset, colors.grass);
                    x++;
                    offset = offset + 4;
                }
                while (true) {
                    if (x == llx2) break;
                    pixel(data, offset, colors.border);
                    x++;
                    offset = offset + 4;
                }
                while (true) {
                    if (x == rrx2) break;
                    pixel(data, offset, colors.road);
                    x++;
                    offset = offset + 4;
                }
                while (true) {
                    if (x == rrx) break;
                    pixel(data, offset, colors.border);
                    x++;
                    offset = offset + 4;
                }
                while (true) {
                    if (x == canvas.width) break;
                    pixel(data, offset, colors.grass);
                    x++;
                    offset = offset + 4;
                }

                y_stripe_offset++; 
                if (y_stripe_offset == stripe_offset_width) {
                    y_stripe_offset = 0;
                    y_stripe_colors_index = 1 - y_stripe_colors_index;
                }
            }

            ctx.putImageData(imageData, 0, 0);

            ctx.drawImage(ferrari, 9, 64,84, 48,120, 180,84, 48);

            stripe_offset--; 
            if (stripe_offset < 0) {
                stripe_offset = stripe_offset_width-1;
                stripe_colors_index = 1 - stripe_colors_index;
            }
        }

        function pixel(data, offset, rgba) {
            data[offset++] = rgba[0];
            data[offset++] = rgba[1];
            data[offset++] = rgba[2];
            data[offset++] = rgba[3];
        }
    </script>
</body>

</html>